generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // BACK TO POSTGRESQL FOR SUPABASE
  url      = env("DATABASE_URL")
}

// User Models
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String
  password      String
  role          Role     @default(TEACHER)
  profileImage  String?
  components    String[] // Back to array
  yearsTeaching Int[]    // Back to array
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  planosDidaticos  PlanoDidatico[]
  comentarios      Comentario[]
  forumPosts       PostForum[]
  trilhasProgresso TrilhaProgresso[]

  @@map("users")
}

enum Role {
  TEACHER
  COORDINATOR
  ADMIN
}

// Educational Content Models
model Habilidade {
  id                  String   @id @default(cuid())
  codigo              String   @unique
  descricao           String   @db.Text
  eixo                Eixo
  conceituoCritico    ConceituoCritico
  anoEscolar          Int
  componente          String
  objetosConhecimento String[]

  planos PlanoDidatico[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([anoEscolar])
  @@index([componente])
  @@map("habilidades")
}

enum Eixo {
  LER
  ESCREVER
  PARTICIPAR
}

enum ConceituoCritico {
  LINGUAGEM
  REPRESENTACAO
  PRODUCAO
  PUBLICO
}

model PlanoDidatico {
  id                String   @id @default(cuid())
  titulo            String
  descricao         String   @db.Text
  anoEscolar        Int
  componentes       String[]
  duracao           Int
  eixos             Eixo[]
  
  objetivos         String[]
  problematizacao   String?  @db.Text
  desenvolvimento   String?  @db.Text
  producaoAvaliacao String?  @db.Text
  
  autor      User     @relation(fields: [autorId], references: [id], onDelete: Cascade)
  autorId    String
  
  compartilhado Boolean @default(false)
  curtidas      Int     @default(0)
  
  habilidades Habilidade[]
  recursos    Recurso[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([autorId])
  @@index([anoEscolar])
  @@map("planos_didaticos")
}

model Recurso {
  id                    String   @id @default(cuid())
  titulo                String
  tipo                  TipoRecurso
  descricao             String   @db.Text
  url                   String?
  anoRecomendado        Int?
  eixo                  Eixo
  tags                  String[]
  roteiros              String?  @db.Text
  perguntasOrientadoras String[]
  
  planos PlanoDidatico[]
  atividades Atividade[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tipo])
  @@index([eixo])
  @@map("recursos")
}

enum TipoRecurso {
  VIDEO
  ARTICULO
  INFOGRAFICO
  FERRAMENTA
  DINAMICA
  AVALIACAO
}

model Atividade {
  id          String   @id @default(cuid())
  titulo      String
  descricao   String   @db.Text
  duracao     Int
  metodologia String
  instrucoes  String   @db.Text
  
  recurso     Recurso? @relation(fields: [recursoId], references: [id], onDelete: Cascade)
  recursoId   String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("atividades")
}

// Learning & Formation Models
model TrilhaAprendizagem {
  id          String   @id @default(cuid())
  titulo      String
  descricao   String   @db.Text
  nivel       Nivel
  duracao     Int
  certificado Boolean  @default(true)
  
  modulos    Modulo[]
  progressos TrilhaProgresso[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("trilhas_aprendizagem")
}

enum Nivel {
  BASICO
  INTERMEDIARIO
  AVANCADO
}

model Modulo {
  id        String   @id @default(cuid())
  titulo    String
  descricao String   @db.Text
  conteudo  String   @db.Text
  duracao   Int
  ordem     Int
  
  trilha    TrilhaAprendizagem @relation(fields: [trilhaId], references: [id], onDelete: Cascade)
  trilhaId  String
  quiz      Quiz?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([trilhaId])
  @@map("modulos")
}

model Quiz {
  id              String   @id @default(cuid())
  pontuacaoMinima Int      @default(70)
  
  modulo    Modulo   @relation(fields: [moduloId], references: [id], onDelete: Cascade)
  moduloId  String   @unique
  questoes  Questao[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("quizzes")
}

model Questao {
  id              String   @id @default(cuid())
  titulo          String
  tipo            TipoQuestao
  opcoes          String[]
  respostaCorreta String?
  
  quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  quizId    String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([quizId])
  @@map("questoes")
}

enum TipoQuestao {
  MULTIPLA
  DISCURSIVA
}

model TrilhaProgresso {
  id        String   @id @default(cuid())
  usuario   User     @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId String
  trilha    TrilhaAprendizagem @relation(fields: [trilhaId], references: [id], onDelete: Cascade)
  trilhaId  String
  
  percentualConcluido Int     @default(0)
  completado          Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([usuarioId, trilhaId])
  @@map("trilha_progressos")
}

// Community Models
model PostForum {
  id        String   @id @default(cuid())
  titulo    String
  conteudo  String   @db.Text
  categoria Categoria
  
  autor     User     @relation(fields: [autorId], references: [id], onDelete: Cascade)
  autorId   String
  
  curtidas  Int      @default(0)
  comentarios Comentario[]
  tags      String[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([autorId])
  @@index([categoria])
  @@map("post_forum")
}

enum Categoria {
  DUVIDAS
  PRATICAS
  CASOS
  DESAFIOS
}

model Comentario {
  id        String   @id @default(cuid())
  conteudo  String   @db.Text
  
  autor     User     @relation(fields: [autorId], references: [id], onDelete: Cascade)
  autorId   String
  
  post      PostForum? @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String?
  
  respostaPara   Comentario? @relation("ComentarioRespostas", fields: [respostaParaId], references: [id], onDelete: Cascade)
  respostaParaId String?
  respostas      Comentario[] @relation("ComentarioRespostas")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([autorId])
  @@index([postId])
  @@map("comentarios")
}
